<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> <meta name="theme-color" content="#f0f2f5">
    <title>Q-Cloud 3D</title>

    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* --- CLAYMORPHISM SYSTEM --- */
        :root {
            --bg: #f0f4f8; /* Blanc cassé très doux */
            --surface: #ffffff;
            --primary: #6c5ce7;
            --primary-soft: #a29bfe;
            --accent: #00cec9;
            --text: #2d3436;
            --text-light: #b2bec3;
            
            /* L'effet "Fluffy 3D" magique */
            --shadow-flat: 
                8px 8px 16px rgba(166, 171, 189, 0.3), 
                -8px -8px 16px rgba(255, 255, 255, 0.8);
            
            --shadow-pressed: 
                inset 6px 6px 10px rgba(166, 171, 189, 0.2), 
                inset -6px -6px 10px rgba(255, 255, 255, 0.8);
            
            --shadow-float: 
                0 20px 50px rgba(108, 92, 231, 0.15), 
                0 10px 20px rgba(108, 92, 231, 0.1);
            
            --radius: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Varela Round', sans-serif; }

        body {
            margin: 0; background-color: var(--bg); color: var(--text);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HEADER FLUFFY --- */
        header {
            padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }
        .logo-area {
            display: flex; align-items: center; gap: 15px;
        }
        .logo-box {
            width: 45px; height: 45px; background: var(--surface);
            border-radius: 16px; box-shadow: var(--shadow-flat);
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; color: var(--primary);
        }
        h1 { font-size: 22px; margin: 0; color: var(--text); }

        /* --- CONTAINER --- */
        .main-stage {
            flex: 1; overflow-y: auto; padding: 10px 25px 120px 25px;
            scroll-behavior: smooth;
        }

        /* --- CARDS (CLAY STYLE) --- */
        .clay-card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow-flat);
            padding: 25px; margin-bottom: 25px;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .clay-card:active { transform: scale(0.98); }

        /* --- GATE ELEMENTS (DRAGGABLE) --- */
        .toolbox-row {
            display: flex; gap: 15px; padding: 10px 5px 25px 5px;
            overflow-x: auto; scrollbar-width: none;
        }
        
        .gate-3d {
            min-width: 60px; height: 60px;
            background: var(--surface);
            border-radius: 18px;
            box-shadow: var(--shadow-flat);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; font-size: 18px; color: var(--primary);
            position: relative; cursor: grab;
            transition: all 0.3s;
        }

        /* Décoration interne pour effet volume */
        .gate-3d::after {
            content:''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255,255,255,1) 0%, rgba(240,240,255,0) 100%);
            pointer-events: none; opacity: 0.5;
        }

        /* L'état quand on soulève l'élément */
        .sortable-drag {
            cursor: grabbing; opacity: 1 !important; background: var(--primary) !important; color: white !important;
            transform: scale(1.2) rotate(5deg) !important;
            box-shadow: 0 30px 60px rgba(108, 92, 231, 0.4) !important;
            z-index: 9999;
        }

        /* Animation Jelly à l'atterrissage */
        @keyframes jelly {
            0% { transform: scale(1, 1); }
            30% { transform: scale(1.25, 0.75); }
            40% { transform: scale(0.75, 1.25); }
            50% { transform: scale(1.15, 0.85); }
            65% { transform: scale(0.95, 1.05); }
            75% { transform: scale(1.05, 0.95); }
            100% { transform: scale(1, 1); }
        }
        .jelly-pop { animation: jelly 0.5s; }

        /* --- CIRCUIT LINES --- */
        .circuit-track {
            display: flex; align-items: center; min-height: 80px;
            background: #f8faff; border-radius: 20px;
            box-shadow: inset 4px 4px 8px rgba(166, 171, 189, 0.1), inset -4px -4px 8px rgba(255,255,255,0.8);
            margin-bottom: 15px; padding: 10px; position: relative;
        }
        .qubit-label {
            font-weight: bold; color: var(--text-light); font-size: 14px;
            width: 40px; text-align: center;
        }
        .drop-area {
            flex: 1; display: flex; align-items: center; gap: 10px;
            overflow-x: auto; min-height: 60px; padding-right: 20px;
        }

        /* --- BIG BUTTON --- */
        .btn-fluffy {
            width: 100%; padding: 20px; border: none; border-radius: 20px;
            background: var(--primary); color: white;
            font-size: 18px; font-weight: bold; letter-spacing: 1px;
            box-shadow: 0 15px 30px rgba(108, 92, 231, 0.3);
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .btn-fluffy:active { transform: scale(0.95); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.2); }
        .btn-fluffy::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
        }

        /* --- FLOATING NAV --- */
        .float-nav {
            position: fixed; bottom: 40px; left: 20px; right: 20px;
            height: 80px; background: var(--surface);
            border-radius: 40px; box-shadow: var(--shadow-float);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding: 0 10px;
        }
        .nav-btn {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-light); font-size: 20px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .nav-btn.active {
            background: var(--bg); color: var(--primary);
            box-shadow: var(--shadow-pressed);
            transform: translateY(-10px);
        }

        /* --- INPUTS --- */
        input {
            width: 100%; border: none; padding: 15px; border-radius: 15px;
            background: #f8faff; box-shadow: inset 4px 4px 8px rgba(166, 171, 189, 0.2), inset -4px -4px 8px rgba(255,255,255,0.8);
            font-size: 16px; color: var(--primary); margin-bottom: 15px; outline: none;
        }

        /* --- TRANSITIONS --- */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s, transform 0.3s; }
        .fade-enter-from { opacity: 0; transform: translateY(20px); }
        .fade-leave-to { opacity: 0; transform: translateY(-20px); }

    </style>
</head>
<body>

<div id="app">

    <header>
        <div class="logo-area">
            <div class="logo-box">
                <i class="fa-solid fa-cloud"></i>
            </div>
            <div>
                <h1>Q-Cloud</h1>
                <div style="font-size:12px; color:var(--text-light)">Quantum Composer</div>
            </div>
        </div>
        <div class="logo-box" style="width:40px; height:40px; font-size:16px; color:var(--text-light)">
            <i class="fa-solid fa-user"></i>
        </div>
    </header>

    <div class="main-stage">
        <transition name="fade" mode="out-in">
            
            <div v-if="view === 'home'" key="home">
                
                <div class="clay-card">
                    <div style="font-size:12px; text-transform:uppercase; color:var(--text-light); font-weight:bold; margin-bottom:10px;">Portes Logiques</div>
                    <div class="toolbox-row" id="toolbox">
                        <div v-for="g in gates" :key="g" class="gate-3d" :data-id="g">
                            {{ g }}
                        </div>
                    </div>
                </div>

                <div class="clay-card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <span style="font-weight:bold; color:var(--text)">Circuit Principal</span>
                        <span style="font-size:12px; color:var(--accent)">IBM_OSAKA • READY</span>
                    </div>

                    <div v-for="(line, idx) in qubits" :key="idx" class="circuit-track">
                        <div class="qubit-label">q{{idx}}</div>
                        <div class="drop-area" :id="'line-'+idx">
                            </div>
                    </div>

                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <button @click="addQubit" style="flex:1; padding:12px; border-radius:15px; border:none; background:var(--bg); color:var(--text-light); font-weight:bold; box-shadow:var(--shadow-flat);">+ Ligne</button>
                        <button @click="resetCircuit" style="flex:1; padding:12px; border-radius:15px; border:none; background:var(--bg); color:var(--text-light); font-weight:bold; box-shadow:var(--shadow-flat); color:#ff7675">Reset</button>
                    </div>
                </div>

                <button class="btn-fluffy" @click="runJob">
                    <span v-if="!loading">LANCER LE CALCUL</span>
                    <span v-else><i class="fa-solid fa-spinner fa-spin"></i> TRAITEMENT...</span>
                </button>

            </div>

            <div v-if="view === 'settings'" key="settings">
                <div class="clay-card">
                    <h2 style="margin-bottom:20px; color:var(--primary)">Connexion API</h2>
                    
                    <label style="font-size:12px; font-weight:bold; color:var(--text-light); margin-left:10px;">N8N Webhook URL</label>
                    <input v-model="settings.n8nUrl" placeholder="https://..." type="url">
                    
                    <label style="font-size:12px; font-weight:bold; color:var(--text-light); margin-left:10px;">IBM Quantum Token</label>
                    <input v-model="settings.token" placeholder="api_token..." type="password">
                    
                    <button class="btn-fluffy" style="margin-top:10px" @click="saveSettings">SAUVEGARDER</button>
                </div>

                <div class="clay-card">
                    <h2 style="margin-bottom:20px; color:var(--primary)">Paramètres</h2>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid #eee;">
                        <span>Haptique</span>
                        <div style="width:40px; height:20px; background:var(--primary); border-radius:10px; position:relative;"><div style="width:16px; height:16px; background:white; border-radius:50%; position:absolute; right:2px; top:2px;"></div></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0;">
                        <span>Mode Sombre</span>
                        <div style="width:40px; height:20px; background:#dfe6e9; border-radius:10px; position:relative;"><div style="width:16px; height:16px; background:white; border-radius:50%; position:absolute; left:2px; top:2px; box-shadow:0 2px 5px rgba(0,0,0,0.2);"></div></div>
                    </div>
                </div>
            </div>

            <div v-if="view === 'results'" key="results">
                <div class="clay-card">
                    <h2 style="color:var(--primary)">Résultats</h2>
                    <div v-if="logs.length === 0" style="text-align:center; padding:30px; color:var(--text-light)">
                        Aucun résultat récent.
                    </div>
                    <div v-else>
                        <div v-for="(l, i) in logs" :key="i" style="background:var(--bg); padding:15px; border-radius:15px; margin-bottom:10px; font-family:monospace; font-size:12px;">
                            <div style="color:var(--accent); font-weight:bold; margin-bottom:5px;">{{ l.time }}</div>
                            {{ l.msg }}
                        </div>
                    </div>
                </div>
            </div>

        </transition>
    </div>

    <div class="float-nav">
        <div class="nav-btn" :class="{active: view==='home'}" @click="view='home'">
            <i class="fa-solid fa-shapes"></i>
        </div>
        <div class="nav-btn" :class="{active: view==='results'}" @click="view='results'">
            <i class="fa-solid fa-chart-simple"></i>
        </div>
        <div class="nav-btn" :class="{active: view==='settings'}" @click="view='settings'">
            <i class="fa-solid fa-gear"></i>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const view = ref('home');
            const gates = ['H', 'X', 'Y', 'Z', 'CX', 'M'];
            const qubits = ref([0, 1]); // 2 qubits initiaux
            const settings = ref({ n8nUrl: '', token: '' });
            const loading = ref(false);
            const logs = ref([]);

            // CONFIG DRAG & DROP
            const initDrag = () => {
                // 1. Source (Toolbox)
                new Sortable(document.getElementById('toolbox'), {
                    group: { name: 'q-shared', pull: 'clone', put: false }, // Clone les items
                    animation: 200,
                    sort: false,
                    onStart: () => { if(navigator.vibrate) navigator.vibrate(10); } // Haptic start
                });

                // 2. Targets (Lignes)
                qubits.value.forEach((_, i) => {
                    const el = document.getElementById('line-'+i);
                    if(el) {
                        new Sortable(el, {
                            group: 'q-shared',
                            animation: 200,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onAdd: (evt) => {
                                // Effet "Jelly" quand on dépose
                                const item = evt.item;
                                item.classList.add('jelly-pop');
                                item.style.background = '#6c5ce7'; // Devient violet
                                item.style.color = 'white';
                                if(navigator.vibrate) navigator.vibrate([10, 30, 10]); // Haptic drop
                                
                                // Retirer la classe d'anim après le rebond
                                setTimeout(() => item.classList.remove('jelly-pop'), 500);
                            }
                        });
                    }
                });
            };

            onMounted(() => {
                const s = localStorage.getItem('qcloud_settings');
                if(s) settings.value = JSON.parse(s);
                
                // Init Drag après le rendu Vue
                setTimeout(initDrag, 500);
            });

            const addQubit = () => {
                qubits.value.push(qubits.value.length);
                setTimeout(initDrag, 100); // Ré-init les nouveaux éléments
            };

            const resetCircuit = () => {
                document.querySelectorAll('.drop-area').forEach(el => el.innerHTML = '');
                if(navigator.vibrate) navigator.vibrate(50);
            };

            const saveSettings = () => {
                localStorage.setItem('qcloud_settings', JSON.stringify(settings.value));
                alert("Sauvegardé !");
            };

            const runJob = async () => {
                if(!settings.value.n8nUrl) {
                    alert("Configurez N8N d'abord !");
                    view.value = 'settings';
                    return;
                }
                
                loading.value = true;
                
                // Récupération visuelle des données (Méthode simple)
                let circuitData = [];
                qubits.value.forEach((_, i) => {
                    const line = document.getElementById('line-'+i);
                    let rowGates = [];
                    line.querySelectorAll('.gate-3d').forEach(g => rowGates.push(g.innerText));
                    circuitData.push(rowGates);
                });

                try {
                    const res = await fetch(settings.value.n8nUrl, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            token: settings.value.token,
                            circuit: circuitData
                        })
                    });
                    const json = await res.json();
                    logs.value.unshift({
                        time: new Date().toLocaleTimeString(),
                        msg: "Job Completed: " + JSON.stringify(json)
                    });
                    view.value = 'results';
                } catch(e) {
                    alert("Erreur: " + e.message);
                } finally {
                    loading.value = false;
                }
            };

            return { view, gates, qubits, settings, loading, logs, addQubit, resetCircuit, saveSettings, runJob };
        }
    }).mount('#app');
</script>

</body>
</html>
