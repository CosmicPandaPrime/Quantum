<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0d1117">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GitHub Q-Quantum</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* --- GITHUB MOBILE THEME EXACT --- */
        :root {
            --bg-canvas: #010409;
            --bg-card: #161b22;
            --bg-input: #0d1117;
            --border: #30363d;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --green: #238636;
            --danger: #da3633;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; }
        
        body { margin: 0; background-color: var(--bg-canvas); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header {
            height: 60px; background: var(--bg-card); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            font-weight: 600; font-size: 16px; z-index: 10;
        }
        .version-tag { font-size: 10px; background: var(--border); padding: 2px 6px; border-radius: 10px; color: var(--text-muted); }

        /* MAIN CONTENT */
        main { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; }

        /* CARDS */
        .card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px;
            padding: 16px; margin-bottom: 16px;
        }
        .card-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* BUTTONS */
        .btn {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--accent);
            padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 14px;
            display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; cursor: pointer;
        }
        .btn:active { background: var(--border); }
        .btn-primary { background: var(--green); color: white; border: none; }
        .btn-sm { width: auto; padding: 4px 10px; font-size: 12px; }

        /* PROJECT LIST */
        .project-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .project-row:last-child { border-bottom: none; }
        .project-icon { color: var(--text-muted); margin-right: 12px; }

        /* EDITOR UI */
        .editor-tabs { display: flex; background: var(--bg-input); border-radius: 6px; padding: 4px; margin-bottom: 15px; border: 1px solid var(--border); }
        .tab { flex: 1; text-align: center; padding: 6px; font-size: 12px; border-radius: 4px; color: var(--text-muted); cursor: pointer; }
        .tab.active { background: var(--border); color: white; font-weight: bold; }

        /* VISUAL CIRCUIT */
        .circuit-scroller { overflow-x: auto; padding-bottom: 10px; }
        .qubit-line { display: flex; align-items: center; height: 50px; border-bottom: 1px solid var(--border); min-width: max-content; }
        .qubit-id { width: 50px; font-family: monospace; color: var(--text-muted); font-size: 12px; position: sticky; left: 0; background: var(--bg-card); z-index: 2; }
        .gate-box {
            width: 40px; height: 40px; margin: 0 4px; border: 1px dashed var(--border);
            border-radius: 6px; display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold; background: var(--bg-input); color: var(--text-muted);
        }
        .gate-box.filled { background: var(--accent); color: white; border: solid 1px var(--accent); }

        /* CODE EDITOR */
        .code-input {
            width: 100%; height: 300px; background: #0d1117; color: #c9d1d9;
            border: 1px solid var(--border); border-radius: 6px; padding: 10px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 12px; line-height: 1.5; resize: none; outline: none;
        }

        /* BOTTOM NAV */
        nav {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: var(--bg-card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 15px; z-index: 100;
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 10px; cursor: pointer; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn i { font-size: 20px; }

        /* INPUTS */
        .input-field {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;
        }

        /* GATE SELECTOR MODAL */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: flex; align-items: flex-end; }
        .modal-content { width: 100%; background: var(--bg-card); padding: 20px; border-radius: 16px 16px 0 0; }
        .gate-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .gate-option {
            aspect-ratio: 1; background: var(--bg-input); border: 1px solid var(--border);
            border-radius: 8px; color: white; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="app">

    <header>
        <div style="display:flex; align-items:center; gap:10px">
            <i class="fa-brands fa-github fa-lg"></i>
            <span>{{ pageTitle }}</span>
        </div>
        <div class="version-tag">v3.0</div>
    </header>

    <main>
        
        <div v-if="currentTab === 'home'">
            <div class="card">
                <div class="card-title">
                    <span>Mes Répositories (Circuits)</span>
                    <button class="btn btn-sm btn-primary" @click="createProject">New</button>
                </div>
                
                <div v-if="projects.length === 0" style="padding:20px; text-align:center; color:var(--text-muted)">
                    Aucun projet. Créez-en un pour commencer.
                </div>

                <div v-for="(p, i) in projects" :key="p.id" class="project-row" @click="openProject(i)">
                    <div style="display:flex; align-items:center">
                        <i class="fa-regular fa-folder project-icon"></i>
                        <div>
                            <div style="font-weight:600">{{ p.name }}</div>
                            <div style="font-size:11px; color:var(--text-muted)">Updated {{ p.date }}</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right project-icon"></i>
                </div>
            </div>

            <div class="card">
                <div class="card-title">État du système (via N8N)</div>
                <div style="font-size:12px; color:var(--text-muted)">
                    <i class="fa-solid fa-circle" :style="{color: n8nConfigured ? '#238636' : '#8b949e'}"></i>
                    {{ n8nConfigured ? 'Webhook Connecté' : 'Webhook Non Configuré' }}
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'editor'">
            <div v-if="!activeProject" style="text-align:center; padding-top:40px">
                <p>Sélectionnez un projet d'abord.</p>
                <button class="btn" @click="currentTab='home'">Retour</button>
            </div>

            <div v-else>
                <input v-model="activeProject.name" class="input-field" style="font-weight:bold">

                <div class="editor-tabs">
                    <div class="tab" :class="{active: activeProject.mode === 'visual'}" @click="activeProject.mode='visual'">Visual Blocks</div>
                    <div class="tab" :class="{active: activeProject.mode === 'code'}" @click="activeProject.mode='code'">Code (Python)</div>
                </div>

                <div v-if="activeProject.mode === 'visual'" class="card">
                    <div class="card-title">
                        <span>Circuit Grid</span>
                        <div>
                            <button class="btn btn-sm" @click="addQubitRow" style="display:inline-flex; width:auto; margin-right:5px">+</button>
                            <button class="btn btn-sm" @click="removeQubitRow" style="display:inline-flex; width:auto; color:var(--danger); border-color:var(--danger)">-</button>
                        </div>
                    </div>
                    
                    <div class="circuit-scroller">
                        <div v-for="(row, qIndex) in activeProject.visualData" :key="qIndex" class="qubit-line">
                            <div class="qubit-id">q[{{qIndex}}]</div>
                            <div v-for="(gate, sIndex) in row" :key="sIndex" 
                                 class="gate-box" :class="{filled: gate}"
                                 @click="openGateModal(qIndex, sIndex)">
                                {{ gate || '+' }}
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeProject.mode === 'code'" class="card">
                    <div class="card-title">
                        <span>Main.py</span>
                        <span style="font-size:10px; color:var(--accent)">Paste allowed</span>
                    </div>
                    <textarea class="code-input" v-model="activeProject.codeData" placeholder="from qiskit import QuantumCircuit..."></textarea>
                </div>

                <button class="btn btn-primary" @click="runOnIBM" :disabled="isRunning">
                    <i v-if="isRunning" class="fa-solid fa-spinner fa-spin"></i>
                    {{ isRunning ? 'Envoi...' : 'Commit & Run via N8N' }}
                </button>

                <div v-if="consoleOutput" class="card" style="margin-top:15px; background:black; border:none;">
                    <div style="font-family:monospace; font-size:11px; color:#238636; white-space:pre-wrap;">{{ consoleOutput }}</div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'settings'">
            <div class="card">
                <div class="card-title">Configuration N8N (Proxy)</div>
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:10px">
                    L'URL de votre webhook N8N qui fera le pont avec IBM.
                </div>
                <input v-model="settings.webhookUrl" class="input-field" placeholder="https://votre-n8n.com/webhook/...">
                
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:10px; margin-top:10px">
                    IBM Quantum Token
                </div>
                <input v-model="settings.ibmToken" type="password" class="input-field" placeholder="Token API...">
                
                <button class="btn" @click="saveSettings">Sauvegarder Config</button>
            </div>

            <div class="card">
                <div class="card-title" style="color:var(--danger)">Zone de danger</div>
                <button class="btn" style="color:var(--danger); border-color:var(--border)" @click="factoryReset">
                    Effacer toutes les données locales
                </button>
            </div>
        </div>

    </main>

    <nav>
        <div class="nav-btn" :class="{active: currentTab === 'home'}" @click="currentTab='home'">
            <i class="fa-solid fa-house"></i><span>Home</span>
        </div>
        <div class="nav-btn" :class="{active: currentTab === 'editor'}" @click="currentTab='editor'">
            <i class="fa-solid fa-code-branch"></i><span>Edit</span>
        </div>
        <div class="nav-btn" :class="{active: currentTab === 'settings'}" @click="currentTab='settings'">
            <i class="fa-solid fa-gear"></i><span>Settings</span>
        </div>
    </nav>

    <div v-if="showModal" class="modal-bg" @click.self="showModal=false">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
                <span>Select Operation</span>
                <i class="fa-solid fa-xmark" @click="showModal=false"></i>
            </div>
            <div class="gate-grid">
                <button class="gate-option" style="color:#a371f7" @click="setGate('H')">H</button>
                <button class="gate-option" style="color:#58a6ff" @click="setGate('X')">X</button>
                <button class="gate-option" style="color:#58a6ff" @click="setGate('Z')">Z</button>
                <button class="gate-option" style="color:#3fb950" @click="setGate('CX')">CX</button>
                <button class="gate-option" style="color:#d29922" @click="setGate('M')">M</button>
                <button class="gate-option" style="color:var(--danger); border-color:var(--danger)" @click="setGate(null)">DEL</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            // STATE PRINCIPAL
            const currentTab = ref('home');
            const projects = ref([]);
            const activeProjIndex = ref(null);
            
            const settings = ref({
                webhookUrl: '',
                ibmToken: ''
            });

            // UI STATE
            const showModal = ref(false);
            const selectedCell = ref({q:0, s:0});
            const isRunning = ref(false);
            const consoleOutput = ref('');

            // --- INITIALISATION (LOAD FROM MEMORY) ---
            onMounted(() => {
                const localProj = localStorage.getItem('gh_q_projects');
                const localSet = localStorage.getItem('gh_q_settings');
                
                if(localProj) projects.value = JSON.parse(localProj);
                if(localSet) settings.value = JSON.parse(localSet);
            });

            // --- AUTO SAVE ---
            watch([projects, settings], () => {
                localStorage.setItem('gh_q_projects', JSON.stringify(projects.value));
                localStorage.setItem('gh_q_settings', JSON.stringify(settings.value));
            }, { deep: true });

            // --- COMPUTED ---
            const activeProject = computed(() => activeProjIndex.value !== null ? projects.value[activeProjIndex.value] : null);
            const pageTitle = computed(() => {
                if(currentTab.value === 'home') return 'Dashboard';
                if(currentTab.value === 'editor') return activeProject.value ? activeProject.value.name : 'Editor';
                return 'Settings';
            });
            const n8nConfigured = computed(() => settings.value.webhookUrl && settings.value.webhookUrl.startsWith('http'));

            // --- ACTIONS PROJETS ---
            const createProject = () => {
                projects.value.unshift({
                    id: Date.now(),
                    name: 'untitled-circuit',
                    date: new Date().toLocaleDateString(),
                    mode: 'visual', // 'visual' ou 'code'
                    // Grille visuelle par défaut (2 qubits, 8 steps)
                    visualData: [ new Array(8).fill(null), new Array(8).fill(null) ],
                    // Code Python par défaut
                    codeData: "from qiskit import QuantumCircuit\n\nqc = QuantumCircuit(2)\nqc.h(0)\nqc.cx(0, 1)\nqc.measure_all()"
                });
                openProject(0);
            };

            const openProject = (index) => {
                activeProjIndex.value = index;
                currentTab.value = 'editor';
            };

            // --- ACTIONS EDITEUR VISUEL ---
            const addQubitRow = () => {
                if(activeProject.value) {
                    const len = activeProject.value.visualData[0].length;
                    activeProject.value.visualData.push(new Array(len).fill(null));
                }
            };
            const removeQubitRow = () => {
                if(activeProject.value && activeProject.value.visualData.length > 1) {
                    activeProject.value.visualData.pop();
                }
            };
            const openGateModal = (q, s) => {
                selectedCell.value = {q, s};
                showModal.value = true;
            };
            const setGate = (gate) => {
                if(activeProject.value) {
                    activeProject.value.visualData[selectedCell.value.q][selectedCell.value.s] = gate;
                }
                showModal.value = false;
            };

            // --- EXECUTION N8N ---
            const runOnIBM = async () => {
                if(!n8nConfigured.value) {
                    alert("Configurez le Webhook N8N dans Settings !");
                    currentTab.value = 'settings';
                    return;
                }

                isRunning.value = true;
                consoleOutput.value = '> Initializing connection via N8N Gateway...\n';

                const payload = {
                    token: settings.value.ibmToken,
                    mode: activeProject.value.mode,
                    // Envoie soit la grille soit le code brut
                    data: activeProject.value.mode === 'code' ? activeProject.value.codeData : activeProject.value.visualData
                };

                try {
                    const res = await fetch(settings.value.webhookUrl, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    const json = await res.json();
                    consoleOutput.value += '> Job sent successfully.\n> Status: COMPLETED\n\nRESULTATS:\n' + JSON.stringify(json, null, 2);
                    
                } catch (e) {
                    consoleOutput.value += `> ERROR: Connection failed.\n> ${e.message}`;
                } finally {
                    isRunning.value = false;
                }
            };

            const saveSettings = () => alert("Configuration sauvegardée !");
            
            const factoryReset = () => {
                if(confirm("ATTENTION : Cela effacera tous vos projets sur ce téléphone. Continuer ?")) {
                    localStorage.clear();
                    location.reload();
                }
            };

            return {
                currentTab, pageTitle, projects, activeProject, 
                settings, n8nConfigured, isRunning, consoleOutput,
                showModal,
                createProject, openProject, addQubitRow, removeQubitRow, 
                openGateModal, setGate, runOnIBM, saveSettings, factoryReset
            };
        }
    }).mount('#app');
</script>

</body>
</html>