<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f4f6f9">
    <title>Q-Cloud Ultimate</title>

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- CLAYMORPHISM PRO --- */
        :root {
            --bg: #f4f6f9;
            --surface: #ffffff;
            --primary: #5e6ad2;
            --primary-dark: #4b55aa;
            --text-main: #2c3e50;
            --text-light: #95a5a6;
            
            /* Ombres douces (Soft UI) */
            --shadow-card: 
                10px 10px 20px rgba(174, 174, 192, 0.4), 
                -10px -10px 20px #ffffff;
            --shadow-inner: 
                inset 5px 5px 10px rgba(174, 174, 192, 0.2), 
                inset -5px -5px 10px #ffffff;
            --shadow-float:
                0 15px 35px rgba(94, 106, 210, 0.25);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Nunito', sans-serif; }

        body {
            margin: 0; background-color: var(--bg); color: var(--text-main);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            height: 70px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            background: var(--bg); z-index: 50;
        }
        .header-title { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .mode-toggle {
            background: #e0e5ec; padding: 4px; border-radius: 20px; display: flex;
            box-shadow: var(--shadow-inner);
        }
        .toggle-btn {
            padding: 6px 15px; border-radius: 16px; font-size: 12px; font-weight: bold; color: var(--text-light);
            transition: all 0.2s;
        }
        .toggle-btn.active { background: var(--surface); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- MAIN SCROLL AREA --- */
        .viewport {
            flex: 1; overflow-y: auto; padding: 10px 20px 140px 20px; /* 140px padding bottom pour ne rien cacher */
            -webkit-overflow-scrolling: touch; /* Fluidité iOS */
        }

        /* --- UI CARDS --- */
        .card {
            background: var(--surface); border-radius: 24px;
            box-shadow: var(--shadow-card); padding: 20px; margin-bottom: 25px;
            position: relative;
        }
        .card h3 { margin: 0 0 15px 0; font-size: 16px; color: var(--text-main); display: flex; justify-content: space-between; }

        /* --- TOOLBOX (SCROLL HORIZONTAL) --- */
        .toolbox-container {
            overflow-x: auto; padding: 10px 5px 20px 5px;
            display: flex; gap: 12px;
            /* Important pour le tactile : permet de scroller horizontalement */
            touch-action: pan-x; 
        }

        .gate-item {
            min-width: 55px; height: 55px;
            background: var(--surface); border-radius: 16px;
            box-shadow: var(--shadow-card);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; font-size: 14px; color: var(--primary);
            position: relative;
            /* CRUCIAL POUR LE DRAG SUR MOBILE : Empêche le navigateur de scroller quand on touche l'élément */
            touch-action: none; 
            cursor: grab;
        }
        .gate-desc { font-size: 8px; opacity: 0.6; margin-top: 2px; font-weight: 600; }
        
        /* Style quand on déplace */
        .sortable-ghost { opacity: 0.4; background: #e0e5ec; }
        .sortable-drag { 
            transform: scale(1.1); background: var(--primary); color: white; opacity: 1 !important; z-index: 9999; 
            box-shadow: 0 20px 40px rgba(94, 106, 210, 0.4);
        }

        /* --- CIRCUIT LINES --- */
        .circuit-line {
            display: flex; align-items: center; min-height: 70px;
            background: #eef2f7; border-radius: 18px;
            margin-bottom: 15px; padding: 5px;
            box-shadow: var(--shadow-inner);
        }
        .qubit-id { 
            width: 40px; font-size: 14px; font-weight: bold; color: var(--text-light); text-align: center; 
        }
        .drop-zone {
            flex: 1; display: flex; align-items: center; gap: 8px;
            overflow-x: auto; padding: 5px 15px 5px 5px; min-height: 60px;
        }

        /* --- CODE EDITOR --- */
        .code-area {
            width: 100%; height: 350px; background: #2c3e50; color: #ecf0f1;
            border-radius: 18px; padding: 15px; border: none; outline: none;
            font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
            resize: none;
        }

        /* --- ACTION BUTTONS --- */
        .btn-big {
            width: 100%; padding: 18px; border: none; border-radius: 20px;
            background: var(--primary); color: white; font-size: 16px; font-weight: 800;
            box-shadow: var(--shadow-float); transition: transform 0.1s;
        }
        .btn-big:active { transform: scale(0.96); }

        .btn-small {
            padding: 8px 16px; border-radius: 12px; border: none; background: var(--bg);
            color: var(--text-light); font-weight: bold; box-shadow: var(--shadow-card);
            margin-right: 10px;
        }
        .btn-small:active { box-shadow: var(--shadow-inner); }

        /* --- BOTTOM NAV (FIXED) --- */
        .navbar {
            position: fixed; bottom: 30px; left: 20px; right: 20px;
            height: 75px; background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 40px; box-shadow: var(--shadow-float);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
        }
        .nav-item {
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            font-size: 22px; color: var(--text-light); border-radius: 50%;
            transition: all 0.3s;
        }
        .nav-item.active {
            background: var(--primary); color: white; transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(94, 106, 210, 0.4);
        }

        /* --- INPUTS --- */
        input {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            background: #eef2f7; box-shadow: var(--shadow-inner); margin-bottom: 15px;
            color: var(--primary); font-weight: bold; outline: none;
        }
    </style>
</head>
<body>

<div id="app">

    <header>
        <div class="header-title">
            <i class="fa-solid fa-cloud-bolt"></i> Q-Cloud
        </div>
        <div class="mode-toggle">
            <div class="toggle-btn" :class="{active: mode==='visual'}" @click="mode='visual'">Visuel</div>
            <div class="toggle-btn" :class="{active: mode==='code'}" @click="mode='code'">Code</div>
        </div>
    </header>

    <div class="viewport">
        
        <transition name="fade" mode="out-in">
            
            <div v-if="view === 'editor'" key="editor">
                
                <div v-show="mode === 'visual'">
                    <div class="card">
                        <h3>
                            Bibliothèque de Portes
                            <span style="font-size:10px; opacity:0.5; font-weight:normal">Glisser vers le bas</span>
                        </h3>
                        <div class="toolbox-container" id="toolbox">
                            <div class="gate-item" data-id="H">H<span class="gate-desc">Had</span></div>
                            <div class="gate-item" data-id="X">X<span class="gate-desc">Not</span></div>
                            <div class="gate-item" data-id="Y">Y<span class="gate-desc">Pauli</span></div>
                            <div class="gate-item" data-id="Z">Z<span class="gate-desc">Phase</span></div>
                            <div class="gate-item" data-id="S">S<span class="gate-desc">Ph/2</span></div>
                            <div class="gate-item" data-id="T">T<span class="gate-desc">Ph/4</span></div>
                            <div class="gate-item" data-id="CX" style="color:#d35400">CX<span class="gate-desc">CNOT</span></div>
                            <div class="gate-item" data-id="CZ" style="color:#d35400">CZ<span class="gate-desc">CPhase</span></div>
                            <div class="gate-item" data-id="SWAP" style="color:#8e44ad">SW<span class="gate-desc">Swap</span></div>
                            <div class="gate-item" data-id="CCX" style="color:#8e44ad">CCX<span class="gate-desc">Toffoli</span></div>
                            <div class="gate-item" data-id="M" style="background:#2c3e50; color:white">M<span class="gate-desc">Mesure</span></div>
                            <div class="gate-item" data-id="RST" style="color:#c0392b">RST<span class="gate-desc">Reset</span></div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>
                            Circuit Principal
                            <div>
                                <button class="btn-small" @click="addQubit">+</button>
                                <button class="btn-small" style="color:#e74c3c" @click="resetLines">Clr</button>
                            </div>
                        </h3>
                        
                        <div v-for="(q, idx) in qubits" :key="idx" class="circuit-line">
                            <div class="qubit-id">q{{idx}}</div>
                            <div class="drop-zone" :id="'line-'+idx"></div>
                        </div>
                    </div>
                </div>

                <div v-show="mode === 'code'">
                    <div class="card">
                        <h3>Éditeur Python / QASM</h3>
                        <textarea v-model="codeContent" class="code-area" placeholder="# Collez votre code Qiskit ou OpenQASM ici...
from qiskit import QuantumCircuit

qc = QuantumCircuit(2)
qc.h(0)
qc.cx(0, 1)
qc.measure_all()"></textarea>
                        <div style="margin-top:15px; font-size:12px; color:#95a5a6">
                            Ce code sera envoyé tel quel au serveur via n8n.
                        </div>
                    </div>
                </div>

                <div style="padding-bottom: 20px;">
                    <button class="btn-big" @click="executeJob">
                        <i v-if="loading" class="fa-solid fa-spinner fa-spin"></i>
                        <span v-else>EXECUTER SUR IBM QUANTUM</span>
                    </button>
                </div>

            </div>

            <div v-if="view === 'settings'" key="settings">
                <div class="card">
                    <h3>Connexion N8N (Bridge)</h3>
                    <div style="font-size:12px; margin-bottom:10px; color:#95a5a6">URL du Webhook</div>
                    <input v-model="settings.url" placeholder="https://..." type="url">
                    
                    <div style="font-size:12px; margin-bottom:10px; color:#95a5a6">Token IBM Quantum</div>
                    <input v-model="settings.token" placeholder="api_token..." type="password">
                    
                    <button class="btn-big" style="background:#2c3e50" @click="saveSettings">SAUVEGARDER CONFIG</button>
                </div>
            </div>

            <div v-if="view === 'logs'" key="logs">
                <div class="card">
                    <h3>Journal d'Exécution</h3>
                    <div v-if="logs.length === 0" style="text-align:center; padding:20px; color:#bdc3c7">
                        Aucun log disponible.
                    </div>
                    <div v-for="(log, i) in logs" :key="i" style="background:#f8f9fa; padding:10px; border-radius:10px; margin-bottom:10px; border-left:4px solid var(--primary); font-family:monospace; font-size:11px; word-break: break-all;">
                        <div style="font-weight:bold; color:#7f8c8d; margin-bottom:4px">{{ log.date }}</div>
                        {{ log.msg }}
                    </div>
                </div>
            </div>

        </transition>

    </div>

    <div class="navbar">
        <div class="nav-item" :class="{active: view==='editor'}" @click="view='editor'">
            <i class="fa-solid fa-layer-group"></i>
        </div>
        <div class="nav-item" :class="{active: view==='logs'}" @click="view='logs'">
            <i class="fa-solid fa-terminal"></i>
        </div>
        <div class="nav-item" :class="{active: view==='settings'}" @click="view='settings'">
            <i class="fa-solid fa-gears"></i>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const view = ref('editor');
            const mode = ref('visual'); // 'visual' ou 'code'
            const qubits = ref([0, 1, 2]); // 3 qubits par défaut
            const settings = ref({ url: '', token: '' });
            const logs = ref([]);
            const loading = ref(false);
            const codeContent = ref('');

            // --- DRAG & DROP ENGINE (Optimisé Mobile) ---
            const initSortable = () => {
                const toolbox = document.getElementById('toolbox');
                if(!toolbox) return;

                // Source (Toolbox)
                new Sortable(toolbox, {
                    group: { name: 'q', pull: 'clone', put: false },
                    sort: false,
                    animation: 150,
                    delay: 0, // Instantané
                    touchStartThreshold: 5 // Tolérance tactile
                });

                // Targets (Lignes)
                qubits.value.forEach((_, i) => {
                    const el = document.getElementById('line-'+i);
                    if(el) {
                        new Sortable(el, {
                            group: 'q',
                            animation: 150,
                            delay: 0,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            fallbackOnBody: true, // IMPORTANT pour mobile: empêche le clipping
                            swapThreshold: 0.65
                        });
                    }
                });
            };

            onMounted(() => {
                const s = localStorage.getItem('qcloud_pro_settings');
                if(s) settings.value = JSON.parse(s);
                // Petit délai pour laisser le DOM se construire
                setTimeout(initSortable, 500);
            });

            // Gestion des qubits
            const addQubit = () => {
                qubits.value.push(qubits.value.length);
                setTimeout(initSortable, 100);
            };
            
            const resetLines = () => {
                document.querySelectorAll('.drop-zone').forEach(el => el.innerHTML = '');
            };

            const saveSettings = () => {
                localStorage.setItem('qcloud_pro_settings', JSON.stringify(settings.value));
                alert("Sauvegarde effectuée.");
            };

            // EXECUTION
            const executeJob = async () => {
                if(!settings.value.url) {
                    alert("Configurez l'URL Webhook N8N dans les réglages.");
                    view.value = 'settings';
                    return;
                }

                loading.value = true;
                let payloadData = null;

                if(mode.value === 'code') {
                    // Envoi du code texte brut
                    payloadData = codeContent.value;
                } else {
                    // Envoi de la grille visuelle (Scraping du DOM car Sortable modifie le DOM)
                    let grid = [];
                    qubits.value.forEach((_, i) => {
                        const line = document.getElementById('line-'+i);
                        let row = [];
                        line.querySelectorAll('.gate-item').forEach(g => row.push(g.getAttribute('data-id')));
                        grid.push(row);
                    });
                    payloadData = grid;
                }

                try {
                    const res = await fetch(settings.value.url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            token: settings.value.token,
                            mode: mode.value,
                            data: payloadData
                        })
                    });
                    const json = await res.json();
                    
                    logs.value.unshift({
                        date: new Date().toLocaleTimeString(),
                        msg: "SUCCESS: " + JSON.stringify(json)
                    });
                    view.value = 'logs'; // Redirection vers les logs
                } catch(e) {
                    alert("Erreur réseau: " + e.message);
                } finally {
                    loading.value = false;
                }
            };

            return { 
                view, mode, qubits, settings, logs, loading, codeContent,
                addQubit, resetLines, saveSettings, executeJob 
            };
        }
    }).mount('#app');
</script>
</body>
</html>
