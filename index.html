<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#010409">
    <title>Q-Hub Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* --- GITHUB DARK THEME --- */
        :root {
            --bg-canvas: #010409; --bg-sec: #161b22; --border: #30363d;
            --text: #c9d1d9; --muted: #8b949e; --blue: #58a6ff; --green: #238636;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body { background: var(--bg-canvas); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* LAYOUT */
        header { height: 60px; background: var(--bg-sec); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-weight: bold; }
        main { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; }
        nav { height: 80px; background: var(--bg-sec); border-top: 1px solid var(--border); position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; padding-bottom: 15px; }
        .nav-item { color: var(--muted); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .nav-item.active { color: var(--blue); }
        .nav-item i { font-size: 20px; }

        /* UI ELEMENTS */
        .card { background: var(--bg-sec); border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 16px; }
        .btn { background: var(--bg-sec); border: 1px solid var(--border); color: var(--blue); padding: 8px 16px; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-primary { background: var(--green); color: white; border: none; }
        input, textarea { width: 100%; background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-family: monospace; }
        
        /* EDITOR */
        .mode-switch { display: flex; background: var(--bg-canvas); border-radius: 6px; padding: 2px; margin-bottom: 15px; border: 1px solid var(--border); }
        .mode-btn { flex: 1; text-align: center; padding: 6px; font-size: 12px; border-radius: 4px; color: var(--muted); }
        .mode-btn.active { background: var(--border); color: white; font-weight: bold; }

        .qubit-track { display: flex; align-items: center; height: 50px; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .qubit-label { min-width: 40px; font-family: monospace; color: var(--muted); }
        .gate-slot { min-width: 40px; height: 40px; margin-left: 8px; border: 1px dashed var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #0d1117; }
        .gate-slot.filled { background: var(--blue); color: white; border: none; }

        /* CODE EDITOR */
        .code-area { height: 300px; font-size: 12px; line-height: 1.5; resize: none; white-space: pre; overflow-x: auto; }

        /* PROJECTS LIST */
        .project-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
        .project-item:hover { opacity: 0.8; }
        .badge { background: var(--border); padding: 2px 8px; border-radius: 10px; font-size: 10px; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 99; display: flex; align-items: flex-end; }
        .bottom-sheet { width: 100%; background: var(--bg-sec); padding: 20px; border-radius: 16px 16px 0 0; animation: slideUp 0.3s; }
        .gates-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .gate-btn { aspect-ratio: 1; background: var(--bg-canvas); border: 1px solid var(--border); border-radius: 8px; color: white; font-weight: bold; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fa-brands fa-github fa-lg"></i>
            <span>{{ pageTitle }}</span>
        </div>
        <div v-if="processing" style="font-size:12px; color:var(--green)">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </div>
    </header>

    <main>
        <div v-if="currentTab === 'projects'">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                    <span>Mes Projets</span>
                    <button class="btn" style="width:auto; margin:0; padding:4px 10px" @click="createNewProject">+ Nouveau</button>
                </div>
                <div v-if="projects.length === 0" style="text-align:center; padding:20px; color:var(--muted)">
                    Aucun projet. Créez-en un !
                </div>
                <div v-for="(proj, index) in projects" :key="proj.id" class="project-item" @click="openProject(index)">
                    <div>
                        <div style="font-weight:600">{{ proj.name }}</div>
                        <div style="font-size:11px; color:var(--muted)">Modifié: {{ proj.lastModified }}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px">
                        <span class="badge">{{ proj.mode }}</span>
                        <i class="fa-solid fa-chevron-right" style="font-size:12px; color:var(--muted)"></i>
                    </div>
                </div>
            </div>
            
            <div class="card" style="border-color:var(--green)">
                <div style="font-weight:bold; margin-bottom:5px; color:var(--green)">Sauvegarde Auto Active</div>
                <div style="font-size:12px; color:var(--muted)">Toutes vos modifications sont enregistrées localement sur cet appareil.</div>
            </div>
        </div>

        <div v-if="currentTab === 'composer'">
            <div v-if="!activeProject" style="text-align:center; padding-top:50px;">
                <p>Aucun projet ouvert.</p>
                <button class="btn btn-primary" @click="currentTab='projects'">Aller aux projets</button>
            </div>

            <div v-else>
                <div class="mode-switch">
                    <div class="mode-btn" :class="{active: activeProject.mode === 'visual'}" @click="activeProject.mode = 'visual'">Visual Blocks</div>
                    <div class="mode-btn" :class="{active: activeProject.mode === 'code'}" @click="activeProject.mode = 'code'">Python Code</div>
                </div>

                <div v-if="activeProject.mode === 'visual'" class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <input v-model="activeProject.name" style="width:60%; margin:0; background:transparent; border:none; padding:0; font-weight:bold; font-size:16px;">
                        <button style="background:none; border:1px solid var(--border); color:var(--text); border-radius:4px; font-size:10px; padding:2px 8px;" @click="addQubit">+ Qubit</button>
                    </div>

                    <div style="overflow-x:auto;">
                        <div v-for="(qubitLine, qIndex) in activeProject.circuit" :key="qIndex" class="qubit-track">
                            <div class="qubit-label">q[{{qIndex}}]</div>
                            <div v-for="(gate, sIndex) in qubitLine" :key="sIndex" 
                                 class="gate-slot" :class="{filled: gate}"
                                 @click="openGateSelector(qIndex, sIndex)">
                                {{ gate || '+' }}
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeProject.mode === 'code'" class="card">
                    <div style="margin-bottom:10px; font-weight:bold">{{ activeProject.name }}.py</div>
                    <textarea v-model="activeProject.codeContent" class="code-area" placeholder="Collez votre code Qiskit ici..."></textarea>
                </div>

                <div class="card">
                    <div style="margin-bottom:10px; font-size:12px; color:var(--muted)">Backend: {{ settings.backend || 'ibm_osaka' }}</div>
                    <button class="btn btn-primary" @click="executeViaN8N" :disabled="processing">
                        {{ processing ? 'Envoi à IBM...' : 'Lancer sur IBM Quantum' }}
                    </button>
                    <div v-if="lastResult" style="margin-top:15px; padding:10px; background:black; border-radius:4px; font-family:monospace; font-size:11px;">
                        > Result: {{ lastResult }}
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'settings'">
            <div class="card">
                <div style="font-weight:bold; margin-bottom:15px">Connexion N8N & IBM</div>
                
                <label style="font-size:12px; color:var(--muted)">URL Webhook N8N</label>
                <input v-model="settings.n8nUrl" placeholder="https://votre-n8n.com/webhook/..." type="url">
                
                <label style="font-size:12px; color:var(--muted)">IBM Quantum Token (Optionnel si géré dans n8n)</label>
                <input v-model="settings.ibmToken" type="password" placeholder="api_token...">

                <label style="font-size:12px; color:var(--muted)">Backend IBM par défaut</label>
                <input v-model="settings.backend" placeholder="ibm_osaka">
                
                <button class="btn" @click="saveSettings">Sauvegarder la config</button>
            </div>
            
            <div class="card">
                <div class="project-item" style="color:var(--text); border:none" @click="wipeData">
                    <span>Réinitialiser l'application</span>
                    <i class="fa-solid fa-trash" style="color:#f85149"></i>
                </div>
            </div>
        </div>
    </main>

    <nav>
        <div class="nav-item" :class="{active: currentTab==='projects'}" @click="currentTab='projects'">
            <i class="fa-solid fa-folder"></i><span>Projets</span>
        </div>
        <div class="nav-item" :class="{active: currentTab==='composer'}" @click="currentTab='composer'">
            <i class="fa-solid fa-microchip"></i><span>Editeur</span>
        </div>
        <div class="nav-item" :class="{active: currentTab==='settings'}" @click="currentTab='settings'">
            <i class="fa-solid fa-gear"></i><span>Config</span>
        </div>
    </nav>

    <div v-if="showGateModal" class="modal-overlay" @click.self="showGateModal=false">
        <div class="bottom-sheet">
            <div style="font-weight:bold; margin-bottom:10px">Ajouter Porte</div>
            <div class="gates-grid">
                <button class="gate-btn" style="color:#a371f7" @click="setGate('H')">H</button>
                <button class="gate-btn" style="color:#58a6ff" @click="setGate('X')">X</button>
                <button class="gate-btn" style="color:#58a6ff" @click="setGate('Z')">Z</button>
                <button class="gate-btn" style="color:#3fb950" @click="setGate('CX')">CX</button>
                <button class="gate-btn" style="color:#d29922" @click="setGate('M')">M</button>
                <button class="gate-btn" style="border-color:#f85149; color:#f85149" @click="setGate(null)">Del</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, watch, onMounted, computed } = Vue;

    createApp({
        setup() {
            // STATE
            const currentTab = ref('projects');
            const projects = ref([]);
            const activeProjectIndex = ref(null);
            const showGateModal = ref(false);
            const selection = ref({q:0, s:0});
            const processing = ref(false);
            const lastResult = ref(null);
            
            const settings = ref({
                n8nUrl: '',
                ibmToken: '',
                backend: 'ibm_brussels'
            });

            // LOAD / SAVE SYSTEM (LOCAL STORAGE)
            onMounted(() => {
                const savedProjects = localStorage.getItem('qhub_projects');
                const savedSettings = localStorage.getItem('qhub_settings');
                if(savedProjects) projects.value = JSON.parse(savedProjects);
                if(savedSettings) settings.value = JSON.parse(savedSettings);
            });

            watch([projects, settings], () => {
                localStorage.setItem('qhub_projects', JSON.stringify(projects.value));
                localStorage.setItem('qhub_settings', JSON.stringify(settings.value));
            }, { deep: true });

            // COMPUTED
            const activeProject = computed(() => {
                return activeProjectIndex.value !== null ? projects.value[activeProjectIndex.value] : null;
            });

            const pageTitle = computed(() => {
                if(currentTab.value === 'projects') return 'Mes Projets';
                if(currentTab.value === 'composer') return activeProject.value ? activeProject.value.name : 'Editeur';
                return 'Paramètres';
            });

            // METHODS
            const createNewProject = () => {
                projects.value.unshift({
                    id: Date.now(),
                    name: 'Nouveau Circuit',
                    mode: 'visual',
                    lastModified: new Date().toLocaleTimeString(),
                    circuit: [[null, null, null, null], [null, null, null, null]], // 2 qubits par défaut
                    codeContent: "from qiskit import QuantumCircuit\n\nqc = QuantumCircuit(2)\nqc.h(0)\nqc.cx(0, 1)\nqc.measure_all()"
                });
                openProject(0);
            };

            const openProject = (index) => {
                activeProjectIndex.value = index;
                currentTab.value = 'composer';
            };

            const addQubit = () => {
                if(activeProject.value) {
                    // Ajoute une ligne vide de la même longueur que la première ligne
                    const length = activeProject.value.circuit[0].length;
                    activeProject.value.circuit.push(new Array(length).fill(null));
                }
            };

            const openGateSelector = (q, s) => {
                selection.value = {q, s};
                showGateModal.value = true;
            };

            const setGate = (gate) => {
                if(activeProject.value) {
                    activeProject.value.circuit[selection.value.q][selection.value.s] = gate;
                    activeProject.value.lastModified = new Date().toLocaleTimeString();
                }
                showGateModal.value = false;
            };

            // --- LIAISON N8N ---
            const executeViaN8N = async () => {
                if(!settings.value.n8nUrl) {
                    alert("Configurez l'URL N8N dans l'onglet Config !");
                    currentTab.value = 'settings';
                    return;
                }

                processing.value = true;
                lastResult.value = null;

                // Préparation des données à envoyer
                const payload = {
                    token: settings.value.ibmToken,
                    backend: settings.value.backend,
                    mode: activeProject.value.mode,
                    // Si mode visual, on envoie la grille, si code, on envoie le texte
                    data: activeProject.value.mode === 'code' ? activeProject.value.codeContent : activeProject.value.circuit
                };

                try {
                    // C'est ici que l'app appelle N8N
                    const response = await fetch(settings.value.n8nUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    lastResult.value = JSON.stringify(result);
                    
                } catch (e) {
                    lastResult.value = "Erreur de connexion N8N: " + e.message;
                } finally {
                    processing.value = false;
                }
            };

            const saveSettings = () => alert("Configuration sauvegardée !");
            const wipeData = () => {
                if(confirm("Tout effacer ?")) {
                    localStorage.clear();
                    location.reload();
                }
            };

            return {
                currentTab, pageTitle, projects, activeProject, 
                showGateModal, processing, lastResult, settings,
                createNewProject, openProject, addQubit, openGateSelector, setGate, 
                executeViaN8N, saveSettings, wipeData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
